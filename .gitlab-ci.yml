
variables:
  MAVEN_HOME: 'C:\\Users\\HP\\Downloads\\apache-maven-3.9.6'


before_script:
  - echo "Checking Maven and Java"
  - $Env:PATH = "$Env:MAVEN_HOME\bin;" + $Env:PATH
  - echo $Env:PATH
  - mvn -v
stages: 
  - build
  - sonarqube-check
  - test
  - deploy
.envoi-splunk: &envoi-splunk
  after_script:
    - |
      if ($CI_JOB_STATUS -eq "failed") {
        $errorExceptionLogs = Get-Content $env:LOG_FILE_PATH | Select-String -Pattern "^\[ERROR\].*Exception:" | ForEach-Object { $_.Line }
        $errorFailedLogs = Get-Content $env:LOG_FILE_PATH | Select-String -Pattern "^\[ERROR\] Failed to execute goal" | ForEach-Object { $_.Line }
        $allErrorLogs = $errorFailedLogs + $errorExceptionLogs
        $message = $allErrorLogs -join "`n"

        $body = @{
          sourcetype = "_json"
          event = @{
            errorlogs = $message
            repository = $CI_PROJECT_NAME
            runner = $CI_RUNNER_ID
            branch = $CI_COMMIT_REF_NAME
            stage = "$CI_JOB_STAGE"
            status = "$CI_JOB_STATUS"
          }
        } | ConvertTo-Json -Compress
        $headers = @{
          "Authorization" = "Splunk $SPLUNK_HEC_TOKEN"
        }
        [System.Net.ServicePointManager]::ServerCertificateValidationCallback = {$true}
        Invoke-RestMethod -Uri $SPLUNK_HEC_ENDPOINT -Method Post -Body $body -Headers $headers -ContentType 'application/json'
      }
      else {
        $body = @{
          sourcetype = "_json"
          event = @{
            repository = $CI_PROJECT_NAME
            branch = $CI_COMMIT_REF_NAME
            stage = "$CI_JOB_STAGE"
            status = "$CI_JOB_STATUS"
          }
        } | ConvertTo-Json -Compress
        $headers = @{
          "Authorization" = "Splunk $SPLUNK_HEC_TOKEN"
        }
        [System.Net.ServicePointManager]::ServerCertificateValidationCallback = {$true}
        Invoke-RestMethod -Uri $SPLUNK_HEC_ENDPOINT -Method Post -Body $body -Headers $headers -ContentType 'application/json'
      }



unit-tests:
  stage: test
  script:
    - $OldJavaHome = $Env:JAVA_HOME  # Sauvegarder l'ancienne valeur de JAVA_HOME
    - $OldPath = $Env:PATH  # Sauvegarder l'ancien PATH

    - $Env:JAVA_HOME = "C:\openlogic-openjdk-8u402-b06-windows-64"
    - $Env:PATH = "$Env:JAVA_HOME\bin;" + $OldPath  # Utiliser temporairement Java 8

    - echo "Using Java 8 for unit tests"
    - java -version
    - mvn -s $CI_PROJECT_DIR\ci-settings.xml clean test | tee test.log

    - $Env:JAVA_HOME = $OldJavaHome  # Restaurer JAVA_HOME apr√®s les tests
    - $Env:PATH = $OldPath
    - java -version
  artifacts:
    paths:
      - test.log
  variables:
    LOG_FILE_PATH: "test.log"
  <<: *envoi-splunk  
   
  
  
  


 
